{% extends "base.html" %}

{% block title %}Doctor Dashboard - Wellora{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<section class="ban-bread-crumb">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">AI Tools</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Doctor Dashboard</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    
</section>

<!-- Doctor Dashboard Overview -->
<section class="department_section hm-one">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="heading clearfix">
                    <h1>WELLORA <span>DOCTOR DASHBOARD</span></h1>
                    <p>Key patient insights, risk distribution and recent activity</p>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-users"></i></div>
                    <div class="stat-number" id="kpi_total_patients">--</div>
                    <div class="stat-label">Patients Today</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-exclamation-triangle"></i></div>
                    <div class="stat-number" id="kpi_high_risk">--</div>
                    <div class="stat-label">High Risk</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-percentage"></i></div>
                    <div class="stat-number" id="kpi_avg_probability">--</div>
                    <div class="stat-label">Avg Probability</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fa fa-check-circle"></i></div>
                    <div class="stat-number" id="kpi_completed">--</div>
                    <div class="stat-label">Completed Assessments</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-lg-8 col-md-12">
                <div class="card chart-card">
                    <h2><i class="fa fa-chart-pie"></i> Risk Distribution</h2>
                    <div class="chart-wrapper">
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card chart-card">
                    <h2><i class="fa fa-stethoscope"></i> Assessments by Condition</h2>
                    <div class="chart-wrapper small">
                        <canvas id="conditionBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Patients Table -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <h2><i class="fa fa-list"></i> Recent Assessments</h2>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Patient ID</th>
                                    <th>Condition</th>
                                    <th>Risk Level</th>
                                    <th>Risk Probability</th>
                                    <th>Confidence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentAssessmentsBody">
                                <tr><td colspan="6">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- CTA to Clinician Dashboard -->
       

    </div>
</section>
{% endblock %}

{% block scripts %}
<style>
.stat-card { margin-bottom: 20px; }
.card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,.06); margin-bottom: 20px; }
.card h2 { margin-bottom: 15px; font-size: 1.05rem; font-weight: 700; color: #2a2a2a; }
.chart-card { padding-bottom: 10px; }
.chart-wrapper { position: relative; width: 100%; height: 360px; }
.chart-wrapper.small { height: 260px; }

.table { width: 100%; border-collapse: collapse; }
.table th, .table td { padding: 14px 16px; border-bottom: 1px solid #eef0f2; }
.table th { text-transform: uppercase; letter-spacing: .5px; font-size: .78rem; color: #6b7280; background: #fafbfc; }
.table tr:hover td { background: #fafafa; }

@media (max-width: 991.98px) {
  .chart-wrapper { height: 300px; }
  .chart-wrapper.small { height: 240px; }
}

@media (max-width: 575.98px) {
  .stat-card { margin-bottom: 15px; }
  .card { padding: 16px; }
}
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Fetch real dashboard data from API endpoint
async function fetchDashboardData() {
    try {
        const response = await fetch('{{ url_for('dashboard_data') }}');
        if (response.ok) {
            const data = await response.json();
            return data;
        } else {
            throw new Error('Failed to fetch dashboard data');
        }
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
        // Return fallback data if API fails
        return {
            kpis: { total: 0, high: 0, avgProb: 0, completed: 0 },
            riskDistribution: { labels: ['High', 'Moderate', 'Low'], values: [0, 0, 0] },
            conditionBreakdown: { labels: ['Kidney', 'Diabetes', 'Heart', 'Liver'], values: [0, 0, 0, 0] },
            recent: []
        };
    }
}

function renderKPIs(kpis) {
    document.getElementById('kpi_total_patients').textContent = kpis.total;
    document.getElementById('kpi_high_risk').textContent = kpis.high;
    document.getElementById('kpi_avg_probability').textContent = kpis.avgProb + '%';
    document.getElementById('kpi_completed').textContent = kpis.completed;
}

function renderRiskDistribution(ctx, data) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: ['#ff6b6b', '#feca57', '#48dbfb']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 10, right: 10, bottom: 10, left: 10 } },
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 10 } } }
        }
    });
}

function renderConditionBreakdown(ctx, data) {
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Assessments',
                data: data.values,
                backgroundColor: '#667eea',
                borderRadius: 6,
                barThickness: 26,
                maxBarThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 10, right: 10, bottom: 0, left: 0 } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f3f5' }, ticks: { color: '#4b5563' } },
                x: { grid: { display: false }, ticks: { color: '#4b5563' } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function renderRecentTable(rows) {
    const tbody = document.getElementById('recentAssessmentsBody');
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6">No recent assessments</td></tr>';
        return;
    }
    tbody.innerHTML = rows.map(r => `
        <tr>
            <td>${r.id}</td>
            <td>${r.condition}</td>
            <td>${r.risk}</td>
            <td>${(r.prob * 100).toFixed(1)}%</td>
            <td>${(r.conf * 100).toFixed(1)}%</td>
            <td><a class="theme-btn" href="{{ url_for('risk_assessment') }}">Review</a></td>
        </tr>
    `).join('');
}

document.addEventListener('DOMContentLoaded', async function() {
    const data = await fetchDashboardData();
    renderKPIs(data.kpis);
    renderRiskDistribution(document.getElementById('riskDistributionChart'), data.riskDistribution);
    renderConditionBreakdown(document.getElementById('conditionBreakdownChart'), data.conditionBreakdown);
    renderRecentTable(data.recent);
});
</script>
{% endblock %}


